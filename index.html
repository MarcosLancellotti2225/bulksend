<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signaturit Bulk Sender</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div class="logo-icon">S</div>
    <h1>Signaturit <span>Bulk Sender</span></h1>
  </div>
  <div class="header-badge">v2</div>
</div>

<!-- STEPS -->
<div class="steps-bar">
  <div class="step-item active" data-step="1" onclick="goToStep(1)"><div class="step-num">1</div><span class="step-label">Config</span></div>
  <div class="step-connector" id="conn-1-2"></div>
  <div class="step-item" data-step="2" onclick="goToStep(2)"><div class="step-num">2</div><span class="step-label">Datos + PDFs</span></div>
  <div class="step-connector" id="conn-2-3"></div>
  <div class="step-item" data-step="3" onclick="goToStep(3)"><div class="step-num">3</div><span class="step-label">Mapeo</span></div>
  <div class="step-connector" id="conn-3-4"></div>
  <div class="step-item" data-step="4" onclick="goToStep(4)"><div class="step-num">4</div><span class="step-label">Env√≠o</span></div>
</div>

<div class="main">

  <!-- ==================== STEP 1: CONFIG ==================== -->
  <div class="panel active" id="panel-1">
    <div class="section-title">Configuraci√≥n</div>
    <div class="section-desc">Solo entorno, token y proxy son obligatorios. Activ√° los campos opcionales que necesites.</div>

    <div class="config-grid">
      <!-- Required fields -->
      <div class="config-card">
        <label>Entorno <span class="req">*</span></label>
        <select id="cfg-env">
          <option value="sandbox">Sandbox</option>
          <option value="production">Producci√≥n</option>
        </select>
      </div>
      <div class="config-card">
        <label>Access Token <span class="req">*</span></label>
        <input type="password" id="cfg-token" placeholder="Tu token de Signaturit..." />
      </div>
      <div class="config-card config-full">
        <label>Supabase Function URL <span class="req">*</span></label>
        <input type="hidden" id="cfg-proxy" value="https://plejrqzzxnypnxxnamxj.supabase.co/functions/v1/signaturit-proxy" />
      </div>

      <!-- Optional with toggles -->
      <div class="config-card">
        <div class="field-toggle">
          <label>Delivery Type</label>
          <label class="toggle-switch"><input type="checkbox" id="tog-delivery" onchange="toggleField('delivery')"><span class="toggle-slider"></span></label>
        </div>
        <select id="cfg-delivery" disabled>
          <option value="email">Email</option>
          <option value="sms">SMS</option>
          <option value="url">URL</option>
        </select>
      </div>
      <div class="config-card">
        <div class="field-toggle">
          <label>Tipo de firma</label>
          <label class="toggle-switch"><input type="checkbox" id="tog-type" onchange="toggleField('type')"><span class="toggle-slider"></span></label>
        </div>
        <select id="cfg-type" disabled>
          <option value="advanced">Advanced</option>
          <option value="simple">Simple</option>
          <option value="smart">Smart</option>
        </select>
      </div>
      <div class="config-card">
        <div class="field-toggle">
          <label>Branding ID</label>
          <label class="toggle-switch"><input type="checkbox" id="tog-branding" onchange="toggleField('branding')"><span class="toggle-slider"></span></label>
        </div>
        <input type="text" id="cfg-branding" placeholder="UUID del branding..." disabled />
      </div>
      <div class="config-card">
        <div class="field-toggle">
          <label>Signing Mode</label>
          <label class="toggle-switch"><input type="checkbox" id="tog-signing-mode" onchange="toggleField('signing-mode')"><span class="toggle-slider"></span></label>
        </div>
        <select id="cfg-signing-mode" disabled>
          <option value="sequential">Sequential</option>
          <option value="parallel">Parallel</option>
        </select>
      </div>

      <!-- Subject & Body with variable support -->
      <div class="config-card config-full">
        <div class="field-toggle">
          <label>Subject (hac√© click en las variables para insertarlas ‚Üì)</label>
          <label class="toggle-switch"><input type="checkbox" id="tog-subject" onchange="toggleField('subject')"><span class="toggle-slider"></span></label>
        </div>
        <input type="text" id="cfg-subject" placeholder="Ej: Firma de contrato - {{signer_name}}" disabled />
      </div>
      <div class="config-card config-full">
        <div class="field-toggle">
          <label>Body (hac√© click en las variables para insertarlas ‚Üì)</label>
          <label class="toggle-switch"><input type="checkbox" id="tog-body" onchange="toggleField('body')"><span class="toggle-slider"></span></label>
        </div>
        <textarea id="cfg-body" rows="2" placeholder="Ej: Estimado/a {{signer_name}}, por favor firme {{filename}}." disabled></textarea>
      </div>
    </div>

    <!-- VARIABLE TOOLBAR -->
    <div class="var-toolbar">
      <div class="var-toolbar-header">
        <h4>üè∑Ô∏è Variables Signaturit</h4>
        <span class="var-count" id="var-count">14</span>
      </div>
      <div class="var-chips" id="var-chips"></div>
    </div>

    <div class="actions">
      <div></div>
      <button class="btn btn-primary" onclick="if(validateStep1()) goToStep(2)">Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- ==================== STEP 2: DATA + FILES ==================== -->
  <div class="panel" id="panel-2">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
      <div class="section-title">Datos CSV</div>
      <button class="btn btn-small btn-outline" onclick="downloadTemplate()">Plantilla CSV</button>
    </div>
    <div class="section-desc">Primera fila = encabezados. Solo <strong>email</strong> es obligatorio.</div>

    <div class="drop-zone" id="csv-zone" onclick="document.getElementById('csv-input').click()"
      ondragover="event.preventDefault(); this.classList.add('dragover')"
      ondragleave="this.classList.remove('dragover')"
      ondrop="event.preventDefault(); this.classList.remove('dragover'); handleCSVDrop(event)">
      <div class="drop-icon">üìã</div>
      <div class="drop-text">Arrastr√° o hac√© click para seleccionar CSV</div>
      <div class="drop-hint">.csv separado por comas o punto y coma</div>
    </div>
    <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="handleCSVFile(this.files[0])" />

    <div class="section-title">Archivos PDF</div>
    <div class="section-desc">Se matchean por nombre con la columna de archivo del CSV.</div>

    <div class="drop-zone" id="pdf-zone" onclick="document.getElementById('pdf-input').click()"
      ondragover="event.preventDefault(); this.classList.add('dragover')"
      ondragleave="this.classList.remove('dragover')"
      ondrop="event.preventDefault(); this.classList.remove('dragover'); handlePDFDrop(event)">
      <div class="drop-icon">üìÇ</div>
      <div class="drop-text">Arrastr√° o hac√© click para seleccionar PDFs</div>
      <div class="drop-hint">Selecci√≥n m√∫ltiple ¬∑ Recomendado m√°x 5MB por PDF</div>
    </div>
    <input type="file" id="pdf-input" accept=".pdf" multiple style="display:none" onchange="handlePDFFiles(this.files)" />

    <div id="pdf-list-area" style="display:none">
      <div class="pdf-list-container">
        <div class="pdf-list-header">
          <h3>PDFs cargados</h3>
          <div class="table-stats" id="pdf-total-stats"></div>
        </div>
        <div class="pdf-list-scroll" id="pdf-list-scroll"></div>
      </div>
    </div>

    <div id="csv-preview" style="display:none">
      <div class="table-container">
        <div class="table-header">
          <h3>Vista previa CSV</h3>
          <div class="table-stats" id="csv-stats"></div>
        </div>
        <div class="table-scroll" id="csv-table-scroll"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Atr√°s</button>
      <button class="btn btn-primary" id="btn-to-mapping" onclick="goToStep(3)" disabled>Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- ==================== STEP 3: MAPPING ==================== -->
  <div class="panel" id="panel-3">
    <div class="section-title">Mapeo de columnas</div>
    <div class="section-desc">Solo <strong>email</strong> es obligatorio. Activ√° los dem√°s con el toggle.</div>

    <div class="mapping-grid">
      <div class="mapping-card">
        <span class="mapping-label">Email <span class="req">*</span></span>
        <select id="map-email" class="map-select"></select>
      </div>
      <div class="mapping-card">
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="toggle-switch"><input type="checkbox" id="mtog-file" checked onchange="toggleMap('file')"><span class="toggle-slider"></span></label>
          <span class="mapping-label">Archivo PDF</span>
        </div>
        <select id="map-file" class="map-select"></select>
      </div>
      <div class="mapping-card">
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="toggle-switch"><input type="checkbox" id="mtog-name" onchange="toggleMap('name')"><span class="toggle-slider"></span></label>
          <span class="mapping-label">Nombre</span>
        </div>
        <select id="map-name" class="map-select" disabled></select>
      </div>
      <div class="mapping-card">
        <div style="display:flex;align-items:center;gap:8px;">
          <label class="toggle-switch"><input type="checkbox" id="mtog-phone" onchange="toggleMap('phone')"><span class="toggle-slider"></span></label>
          <span class="mapping-label">Tel√©fono</span>
        </div>
        <select id="map-phone" class="map-select" disabled></select>
      </div>
    </div>

    <div class="custom-fields-area">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
        <div class="section-title" style="margin-bottom:0; font-size:13px;">Campos custom data[key]</div>
        <button class="btn btn-small btn-outline" onclick="addCustomField()">+ A√±adir</button>
      </div>
      <div id="custom-fields-list"></div>
      <div style="font-size:11px; color:var(--text-dim); margin-top:4px;">Se env√≠an como data[key]. √ötil para CRM ID, departamento, etc.</div>
    </div>

    <div id="match-preview" style="display:none">
      <div class="table-container">
        <div class="table-header">
          <h3>Preview</h3>
          <div class="table-stats" id="match-stats"></div>
        </div>
        <div class="table-scroll" id="match-table-scroll"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Atr√°s</button>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" onclick="generatePreview()">Preview</button>
        <button class="btn btn-primary" id="btn-to-send" onclick="goToStep(4)" disabled>Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ==================== STEP 4: SEND ==================== -->
  <div class="panel" id="panel-4">
    <div class="section-title">Env√≠o masivo</div>
    <div class="section-desc">Env√≠o via Supabase Edge Function ‚Üí Signaturit API.</div>

    <div class="summary-box" id="send-summary"></div>

    <div class="delay-config">
      <label>Delay entre env√≠os:</label>
      <input type="number" id="cfg-delay" value="1000" min="300" max="10000" step="100" />
      <span>ms (1000ms = ~8 min para 500 env√≠os)</span>
    </div>

    <div class="progress-area" id="progress-area" style="display:none">
      <div class="progress-bar-container"><div class="progress-bar-fill" id="progress-fill"></div></div>
      <div class="progress-stats">
        <span id="progress-text">0 / 0</span>
        <span id="progress-percent">0%</span>
      </div>
    </div>

    <div class="log-area" id="log-area" style="display:none"></div>

    <div id="send-results" style="display:none">
      <div class="table-container">
        <div class="table-header">
          <h3>Resultados</h3>
          <div class="table-stats" id="results-stats"></div>
        </div>
        <div class="table-scroll" id="results-table-scroll"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="goToStep(3)" id="btn-back-send">‚Üê Atr√°s</button>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" id="btn-export-log" onclick="exportLog()" style="display:none">Exportar log</button>
        <button class="btn btn-success" id="btn-send" onclick="startSending()">Iniciar env√≠o</button>
      </div>
    </div>
  </div>

</div>

<!-- VARIABLE MODAL -->
<div class="modal-overlay" id="variable-modal" onclick="if(event.target===this) closeVariableModal()">
  <div class="modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3 style="margin-bottom:0;">üè∑Ô∏è Gestionar Variables</h3>
      <button class="btn btn-small btn-secondary" onclick="closeVariableModal()">‚úï</button>
    </div>
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px;">
      Las <strong>14 variables oficiales</strong> de Signaturit + las tuyas custom. Hac√© click en cualquiera para insertarla en Subject o Body.
    </p>
    <div id="modal-var-list" class="modal-var-list"></div>
    <div class="modal-add-row">
      <input type="text" id="new-var-input" placeholder="nueva_variable (sin espacios)" onkeypress="if(event.key==='Enter') addCustomVariable()" />
      <button class="btn btn-small btn-primary" onclick="addCustomVariable()">A√±adir</button>
    </div>
    <button class="btn btn-navy" style="width:100%" onclick="closeVariableModal()">Cerrar</button>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
