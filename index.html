<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signaturit Sender</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2300B4B6'/><text x='50' y='68' font-size='60' font-weight='800' fill='white' text-anchor='middle' font-family='Arial'>S</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<!-- ===== LAUNCHER ===== -->
<div class="launcher-overlay" id="launcherOverlay">
  <div class="launcher">
    <div class="launcher-header">
      <div class="launcher-logo">S</div>
      <h2>Signaturit Sender</h2>
      <p>Selecciona el tipo de solicitud</p>
    </div>

    <!-- Step 1: Type -->
    <div class="launcher-step active" id="launcherStep1">
      <div class="launcher-label">Tipo de solicitud</div>
      <div class="launcher-options">
        <div class="launcher-option" data-type="advanced" onclick="selectOperationType(this)">
          <div class="launcher-option-icon sig">âœï¸</div>
          <div class="launcher-option-text">
            <h4>Firma avanzada</h4>
            <p>BiomÃ©trica o con certificado digital</p>
          </div>
        </div>
        <div class="launcher-option" data-type="simple" onclick="selectOperationType(this)">
          <div class="launcher-option-icon sig" style="background:rgba(0,180,182,.08)">â˜‘ï¸</div>
          <div class="launcher-option-text">
            <h4>Firma simple</h4>
            <p>Firma con un clic</p>
          </div>
        </div>
        <div class="launcher-option" data-type="email" onclick="selectOperationType(this)">
          <div class="launcher-option-icon email">ğŸ“§</div>
          <div class="launcher-option-text">
            <h4>Email certificado</h4>
            <p>Certifica tus comunicaciones</p>
          </div>
        </div>
        <div class="launcher-option" data-type="sms" onclick="selectOperationType(this)">
          <div class="launcher-option-icon sms">ğŸ’¬</div>
          <div class="launcher-option-text">
            <h4>SMS certificado</h4>
            <p>Certifica tus mensajes SMS</p>
          </div>
        </div>
      </div>
      <div class="launcher-actions">
        <div class="launcher-dots"><div class="launcher-dot active"></div><div class="launcher-dot"></div></div>
        <button class="btn btn-primary" id="launcherNext1" disabled onclick="goLauncherStep(2)">Siguiente â†’</button>
      </div>
    </div>

    <!-- Step 2: Mode -->
    <div class="launcher-step" id="launcherStep2">
      <div class="launcher-label">Â¿CÃ³mo quieres enviar?</div>
      <div class="launcher-options">
        <div class="launcher-option" data-mode="individual" onclick="selectSendMode(this)">
          <div class="launcher-option-icon single">ğŸ‘¤</div>
          <div class="launcher-option-text">
            <h4>EnvÃ­o individual</h4>
            <p>Un destinatario, configura todo manualmente</p>
          </div>
        </div>
        <div class="launcher-option" data-mode="bulk" onclick="selectSendMode(this)">
          <div class="launcher-option-icon bulk">ğŸ‘¥</div>
          <div class="launcher-option-text">
            <h4>EnvÃ­o masivo</h4>
            <p>MÃºltiples destinatarios desde archivo de datos</p>
          </div>
        </div>
      </div>
      <div class="launcher-actions">
        <div class="launcher-dots"><div class="launcher-dot"></div><div class="launcher-dot active"></div></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="goLauncherStep(1)">â† AtrÃ¡s</button>
          <button class="btn btn-primary" id="launcherStart" disabled onclick="startApp()">Comenzar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== APP ===== -->
<div class="app-wrapper" id="appWrapper">
  <header class="header">
    <div class="header-left">
      <div class="logo-icon">S</div>
      <h1>Signaturit <span>Sender</span></h1>
    </div>
    <div class="header-badges">
      <span class="header-badge mode-tag" id="badgeOperation"></span>
      <span class="header-badge" id="badgeMode"></span>
      <button class="btn-change-mode" onclick="resetLauncher()">â† Cambiar modo</button>
    </div>
  </header>

  <!-- ===== INDIVIDUAL MODE ===== -->
  <div id="individualMode" style="display:none">
    <div class="main">
      <h2 class="section-title" id="individualTitle"></h2>
      <p class="section-desc" id="individualDesc"></p>

      <div class="config-grid">
        <div class="config-card">
          <label>Entorno <span class="req">*</span></label>
          <select id="ind-env">
            <option value="https://api.signaturit.com">ProducciÃ³n</option>
            <option value="https://api.sandbox.signaturit.com">Sandbox</option>
          </select>
        </div>
        <div class="config-card">
          <label>Token API <span class="req">*</span></label>
          <input type="password" id="ind-token" placeholder="Pega tu token aquÃ­">
        </div>
      </div>

      <!-- Plantilla toggle -->
      <div class="config-card config-full" id="ind-tpl-section" style="margin-bottom:14px">
        <div class="field-toggle">
          <label>Usar plantilla</label>
          <label class="toggle-switch"><input type="checkbox" id="ind-tpl-toggle" onchange="toggleIndTemplate()"><span class="toggle-slider"></span></label>
        </div>
        <div id="ind-tpl-picker" style="display:none;margin-top:8px">
          <div style="display:flex;gap:8px">
            <select id="ind-tpl-select" style="flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:7px;font-size:13px;background:var(--surface-2)"><option value="">â€” Carga las plantillas primero â€”</option></select>
            <button class="btn btn-outline btn-small" onclick="fetchTemplates('ind')">ğŸ”„ Cargar</button>
          </div>
        </div>
      </div>

      <!-- Multi-signer section (advanced) -->
      <div class="signers-section" id="ind-signers-section" style="display:none">
        <h4>Firmantes</h4>
        <div id="ind-signers-list"></div>
        <button class="btn-add" onclick="addIndSigner()">+ AÃ±adir firmante</button>
      </div>

      <!-- Single recipient (non-advanced) -->
      <div id="ind-single-recipient">
        <div class="config-grid">
          <div class="config-card">
            <label>Email destinatario <span class="req">*</span></label>
            <input type="email" id="ind-email" placeholder="destinatario@email.com">
          </div>
          <div class="config-card">
            <label>Nombre destinatario</label>
            <input type="text" id="ind-name" placeholder="Nombre completo">
          </div>
        </div>
      </div>

      <!-- Subject/Body/Branding -->
      <div class="config-card config-full" style="margin-bottom:14px">
        <div class="field-toggle"><label>Asunto</label><label class="toggle-switch"><input type="checkbox" id="ind-subject-toggle"><span class="toggle-slider"></span></label></div>
        <input type="text" id="ind-subject" placeholder="Asunto del email" disabled>
      </div>
      <div class="config-card config-full" style="margin-bottom:14px">
        <div class="field-toggle"><label>Cuerpo del email</label><label class="toggle-switch"><input type="checkbox" id="ind-body-toggle"><span class="toggle-slider"></span></label></div>
        <textarea id="ind-body" rows="3" placeholder="Cuerpo del mensaje..." disabled></textarea>
      </div>
      <div class="config-card config-full" style="margin-bottom:14px">
        <div class="field-toggle"><label>Branding ID</label><label class="toggle-switch"><input type="checkbox" id="ind-branding-toggle"><span class="toggle-slider"></span></label></div>
        <input type="text" id="ind-branding" placeholder="ID del branding" disabled>
      </div>

      <!-- SMS fields -->
      <div id="ind-sms-fields" style="display:none">
        <div class="config-card config-full" style="margin-bottom:14px">
          <label>TelÃ©fono <span class="req">*</span></label>
          <input type="text" id="ind-phone" placeholder="+34600000000">
        </div>
        <div class="config-card config-full" style="margin-bottom:14px">
          <label>Cuerpo del SMS <span class="req">*</span></label>
          <textarea id="ind-sms-body" rows="3" placeholder="Texto del SMS certificado..."></textarea>
        </div>
      </div>

      <!-- File upload -->
      <div id="ind-file-section">
        <div class="drop-zone" id="indDropZone" onclick="document.getElementById('indFileInput').click()">
          <div class="drop-icon">ğŸ“„</div>
          <div class="drop-text">Arrastra un PDF o haz clic para seleccionar</div>
          <div class="drop-hint">MÃ¡ximo 5 MB</div>
        </div>
        <input type="file" id="indFileInput" accept=".pdf" style="display:none">
      </div>

      <div class="actions">
        <div></div>
        <button class="btn btn-success" onclick="sendIndividual()">ğŸš€ Enviar</button>
      </div>
      <div class="log-area" id="indLog" style="display:none"></div>
    </div>
  </div>

  <!-- ===== BULK MODE ===== -->
  <div id="bulkMode" style="display:none">
    <div class="steps-bar">
      <div class="step-item active" onclick="goToStep(1)"><div class="step-num">1</div><span class="step-label">ConfiguraciÃ³n</span></div>
      <div class="step-connector"></div>
      <div class="step-item" onclick="goToStep(2)"><div class="step-num">2</div><span class="step-label">Archivos</span></div>
      <div class="step-connector"></div>
      <div class="step-item" onclick="goToStep(3)"><div class="step-num">3</div><span class="step-label">Mapeo</span></div>
      <div class="step-connector"></div>
      <div class="step-item" onclick="goToStep(4)"><div class="step-num">4</div><span class="step-label">EnvÃ­o</span></div>
    </div>
    <div class="main">

      <!-- STEP 1 -->
      <div class="panel active" id="panel1">
        <h2 class="section-title">ConfiguraciÃ³n</h2>
        <p class="section-desc">Configura el entorno y las opciones del envÃ­o</p>
        <div class="config-grid">
          <div class="config-card"><label>Entorno <span class="req">*</span></label><select id="cfg-env"><option value="https://api.signaturit.com">ProducciÃ³n</option><option value="https://api.sandbox.signaturit.com">Sandbox</option></select></div>
          <div class="config-card"><label>Token API <span class="req">*</span></label><input type="password" id="cfg-token" placeholder="Pega tu token aquÃ­"></div>
        </div>

        <!-- Plantilla toggle -->
        <div class="config-card config-full" id="bulk-tpl-section" style="margin-bottom:14px">
          <div class="field-toggle">
            <label>Usar plantilla</label>
            <label class="toggle-switch"><input type="checkbox" id="bulk-tpl-toggle" onchange="toggleBulkTemplate()"><span class="toggle-slider"></span></label>
          </div>
          <div id="bulk-tpl-picker" style="display:none;margin-top:8px">
            <div style="display:flex;gap:8px">
              <select id="bulk-tpl-select" style="flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:7px;font-size:13px;background:var(--surface-2)"><option value="">â€” Carga las plantillas primero â€”</option></select>
              <button class="btn btn-outline btn-small" onclick="fetchTemplates('bulk')">ğŸ”„ Cargar</button>
            </div>
          </div>
        </div>

        <div class="config-grid">
          <div class="config-card">
            <div class="field-toggle"><label>Asunto</label><label class="toggle-switch"><input type="checkbox" id="toggle-subject" onchange="toggleField('cfg-subject',this)"><span class="toggle-slider"></span></label></div>
            <input type="text" id="cfg-subject" placeholder="Asunto del email" disabled>
          </div>
          <div class="config-card">
            <div class="field-toggle"><label>Branding ID</label><label class="toggle-switch"><input type="checkbox" id="toggle-branding" onchange="toggleField('cfg-branding',this)"><span class="toggle-slider"></span></label></div>
            <input type="text" id="cfg-branding" placeholder="ID del branding" disabled>
          </div>
          <div class="config-card config-full">
            <div class="field-toggle"><label>Cuerpo del email</label><label class="toggle-switch"><input type="checkbox" id="toggle-body" onchange="toggleField('cfg-body',this)"><span class="toggle-slider"></span></label></div>
            <textarea id="cfg-body" rows="3" placeholder="Usa variables como {{signer_name}}..." disabled></textarea>
          </div>
        </div>

        <!-- SMS body -->
        <div class="config-card config-full" id="bulk-sms-section" style="display:none;margin-bottom:14px">
          <label>Cuerpo del SMS <span class="req">*</span></label>
          <textarea id="cfg-sms-body" rows="3" placeholder="Texto del SMS..."></textarea>
        </div>

        <!-- Variables -->
        <div class="var-toolbar" id="varToolbar">
          <div class="var-toolbar-header"><h4>ğŸ“Œ Variables</h4><span class="var-count" id="varCount">14</span></div>
          <div class="var-chips" id="varChips"></div>
        </div>
        <div class="actions"><div></div><button class="btn btn-primary" onclick="goToStep(2)">Siguiente â†’</button></div>
      </div>

      <!-- STEP 2 -->
      <div class="panel" id="panel2">
        <h2 class="section-title">Subir archivos</h2>
        <p class="section-desc">Sube el archivo de datos (<strong>CSV, JSON o XLSX</strong>) y opcionalmente los PDFs</p>

        <div class="files-layout">
          <div class="files-main">
            <div class="drop-zone" id="dataDropZone" onclick="document.getElementById('dataInput').click()">
              <div class="drop-icon">ğŸ“‹</div>
              <div class="drop-text">Arrastra tu archivo de datos o haz clic</div>
              <div class="drop-hint">CSV, JSON o XLSX</div>
            </div>
            <input type="file" id="dataInput" accept=".csv,.json,.xlsx,.xls" style="display:none">

            <div id="pdfUploadSection">
              <div class="drop-zone" id="pdfDropZone" onclick="document.getElementById('pdfInput').click()">
                <div class="drop-icon">ğŸ“</div>
                <div class="drop-text">PDFs opcionales â€” arrastra o haz clic</div>
                <div class="drop-hint">Se emparejan por nombre con la columna del archivo</div>
              </div>
              <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none">
              <div class="pdf-list-container" id="pdfListContainer" style="display:none">
                <div class="pdf-list-header"><h3>ğŸ“ Archivos PDF</h3><span id="pdfCount" class="stat-badge">0</span></div>
                <div class="pdf-list-scroll" id="pdfListBody"></div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="files-sidebar" id="filesSidebar">
            <h4>ğŸ“– Columnas esperadas</h4>
            <div id="colDescriptions"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-secondary" onclick="goToStep(1)">â† AtrÃ¡s</button>
          <button class="btn btn-primary" onclick="goToStep(3)">Siguiente â†’</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="panel" id="panel3">
        <h2 class="section-title">Mapeo de columnas</h2>
        <p class="section-desc" id="mappingDesc"></p>
        <div id="mappingArea"></div>
        <div class="table-container" id="previewContainer" style="display:none">
          <div class="table-header"><h3>Vista previa</h3><div class="table-stats" id="previewStats"></div></div>
          <div class="table-scroll"><table><thead id="previewHead"></thead><tbody id="previewBody"></tbody></table></div>
        </div>
        <div class="actions">
          <button class="btn btn-secondary" onclick="goToStep(2)">â† AtrÃ¡s</button>
          <button class="btn btn-primary" onclick="goToStep(4)">Siguiente â†’</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="panel" id="panel4">
        <h2 class="section-title">Enviar</h2>
        <p class="section-desc">Revisa el resumen y lanza el envÃ­o</p>
        <div class="summary-box" id="summaryBox"></div>
        <div class="delay-config"><label>â± Delay:</label><input type="number" id="cfg-delay" value="2" min="0" max="60"><span>segundos</span></div>
        <div class="actions" style="margin-bottom:18px">
          <button class="btn btn-secondary" onclick="goToStep(3)">â† AtrÃ¡s</button>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" id="btnStop" onclick="stopSending()" style="display:none">â¹ Detener</button>
            <button class="btn btn-success" id="btnSend" onclick="startBulkSend()">ğŸš€ Iniciar envÃ­o</button>
          </div>
        </div>
        <div class="progress-area" id="progressArea" style="display:none">
          <div class="progress-bar-container"><div class="progress-bar-fill" id="progressFill"></div></div>
          <div class="progress-stats"><span id="progressText">0/0</span><span id="progressPct">0%</span></div>
        </div>
        <div class="log-area" id="logArea" style="display:none"></div>
        <div class="table-container" id="resultsContainer" style="display:none">
          <div class="table-header"><h3>Resultados</h3><div class="table-stats" id="resultsStats"></div></div>
          <div class="table-scroll"><table><thead id="resultsHead"></thead><tbody id="resultsBody"></tbody></table></div>
        </div>
        <div id="exportArea" style="display:none;padding-top:10px"><button class="btn btn-outline btn-small" onclick="exportLog()">ğŸ“¥ Exportar log</button></div>
      </div>

    </div>
  </div>
</div>

<!-- Variable modal -->
<div class="modal-overlay" id="varModal">
  <div class="modal">
    <h3>Variables disponibles</h3>
    <div class="modal-var-list" id="modalVarList"></div>
    <div class="modal-add-row">
      <input type="text" id="newVarName" placeholder="nombre_variable">
      <input type="text" id="newVarDesc" placeholder="DescripciÃ³n">
      <button class="btn btn-primary btn-small" onclick="addCustomVariable()">AÃ±adir</button>
    </div>
    <div style="text-align:right"><button class="btn btn-secondary btn-small" onclick="closeVarModal()">Cerrar</button></div>
  </div>
</div>

<script src="app.js"></script>
</body>
</html>
