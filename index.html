<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signaturit Bulk Sender</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface-2: #1a1a26;
    --surface-3: #222233;
    --border: #2a2a3d;
    --border-active: #4a4a6a;
    --text: #e8e8f0;
    --text-muted: #8888a8;
    --text-dim: #5a5a78;
    --accent: #6c5ce7;
    --accent-light: #a29bfe;
    --success: #00cec9;
    --success-dim: #00b8b3;
    --warning: #fdcb6e;
    --error: #ff6b6b;
    --error-dim: #e55656;
    --gradient: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* === HEADER === */
  .header {
    padding: 24px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px);
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
    background: var(--gradient);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: white;
  }

  .header h1 {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .header h1 span {
    color: var(--accent-light);
  }

  .header-badge {
    background: var(--surface-2);
    border: 1px solid var(--border);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  /* === STEPS === */
  .steps-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px 32px;
    gap: 0;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }

  .step-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .step-item.active { background: var(--surface-3); }
  .step-item.completed .step-num { background: var(--success); color: var(--bg); }

  .step-num {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--surface-3);
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.3s;
  }

  .step-item.active .step-num {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .step-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.3s;
  }

  .step-item.active .step-label { color: var(--text); }
  .step-item.completed .step-label { color: var(--success); }

  .step-connector {
    width: 40px;
    height: 2px;
    background: var(--border);
    transition: all 0.3s;
  }

  .step-connector.active { background: var(--accent); }

  /* === MAIN CONTENT === */
  .main {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px;
  }

  .panel {
    display: none;
    animation: fadeIn 0.4s ease;
  }

  .panel.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* === CONFIG PANEL === */
  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  .config-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }

  .config-card label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .config-card input, .config-card select {
    width: 100%;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }

  .config-card input:focus, .config-card select:focus {
    border-color: var(--accent);
  }

  .config-card select option { background: var(--surface-2); }

  .config-full { grid-column: 1 / -1; }

  /* === UPLOAD ZONES === */
  .upload-section {
    margin-bottom: 28px;
  }

  .section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-desc {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 48px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--surface);
  }

  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(108, 92, 231, 0.05);
  }

  .drop-zone.has-file {
    border-color: var(--success);
    border-style: solid;
    background: rgba(0, 206, 201, 0.03);
  }

  .drop-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.6;
  }

  .drop-text {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .drop-hint {
    font-size: 12px;
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
  }

  .file-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    color: var(--success);
  }

  /* === TABLE === */
  .table-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .table-header h3 {
    font-size: 14px;
    font-weight: 600;
  }

  .table-stats {
    display: flex;
    gap: 16px;
  }

  .stat-badge {
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    padding: 4px 10px;
    border-radius: 6px;
    background: var(--surface-2);
    border: 1px solid var(--border);
  }

  .stat-badge.success { color: var(--success); border-color: rgba(0, 206, 201, 0.3); }
  .stat-badge.warning { color: var(--warning); border-color: rgba(253, 203, 110, 0.3); }
  .stat-badge.error { color: var(--error); border-color: rgba(255, 107, 107, 0.3); }

  .table-scroll {
    max-height: 400px;
    overflow-y: auto;
  }

  .table-scroll::-webkit-scrollbar { width: 6px; }
  .table-scroll::-webkit-scrollbar-track { background: var(--surface); }
  .table-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead {
    position: sticky;
    top: 0;
    z-index: 5;
  }

  th {
    background: var(--surface-2);
    padding: 10px 16px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  tr:hover td { background: rgba(108, 92, 231, 0.03); }

  .status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
  }

  .status-dot.matched { background: var(--success); }
  .status-dot.missing { background: var(--error); }
  .status-dot.pending { background: var(--text-dim); }
  .status-dot.sent { background: var(--success); box-shadow: 0 0 8px rgba(0, 206, 201, 0.5); }
  .status-dot.failed { background: var(--error); box-shadow: 0 0 8px rgba(255, 107, 107, 0.5); }
  .status-dot.sending { background: var(--warning); animation: pulse 1s infinite; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* === MAPPING === */
  .mapping-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .mapping-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .mapping-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--accent-light);
  }

  .mapping-card select {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    outline: none;
    min-width: 180px;
  }

  /* === CUSTOM FIELDS === */
  .custom-fields-area {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .custom-field-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }

  .custom-field-row input {
    flex: 1;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    outline: none;
  }

  .custom-field-row select {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    outline: none;
    min-width: 180px;
  }

  .btn-remove-field {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--error);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
  }

  .btn-remove-field:hover { background: rgba(255, 107, 107, 0.1); border-color: var(--error); }

  /* === BUTTONS === */
  .actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 16px;
  }

  .btn {
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--gradient);
    color: white;
  }

  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108, 92, 231, 0.4); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

  .btn-secondary {
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text);
  }

  .btn-secondary:hover { border-color: var(--border-active); }

  .btn-success {
    background: var(--success);
    color: var(--bg);
  }

  .btn-success:hover { background: var(--success-dim); }
  .btn-success:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-small {
    padding: 6px 14px;
    font-size: 12px;
    border-radius: 6px;
  }

  .btn-outline {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent-light);
  }

  .btn-outline:hover { background: rgba(108, 92, 231, 0.1); }

  /* === PROGRESS === */
  .progress-area {
    margin-bottom: 24px;
  }

  .progress-bar-container {
    background: var(--surface-2);
    border-radius: 8px;
    height: 8px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--gradient);
    border-radius: 8px;
    transition: width 0.4s ease;
    width: 0%;
  }

  .progress-stats {
    display: flex;
    justify-content: space-between;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-muted);
  }

  /* === LOG === */
  .log-area {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    max-height: 200px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    margin-bottom: 24px;
  }

  .log-line {
    padding: 3px 0;
    color: var(--text-muted);
  }

  .log-line.success { color: var(--success); }
  .log-line.error { color: var(--error); }
  .log-line.info { color: var(--accent-light); }

  /* === MODE TOGGLE === */
  .mode-toggle {
    display: flex;
    gap: 2px;
    background: var(--surface-2);
    border-radius: 8px;
    padding: 3px;
    margin-bottom: 24px;
    border: 1px solid var(--border);
    width: fit-content;
  }

  .mode-btn {
    padding: 8px 20px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mode-btn.active {
    background: var(--accent);
    color: white;
  }

  /* === WEBHOOK INFO === */
  .webhook-info {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .webhook-info code {
    background: var(--surface-2);
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--accent-light);
  }

  /* === RESPONSIVE === */
  @media (max-width: 768px) {
    .config-grid, .mapping-grid { grid-template-columns: 1fr; }
    .header { padding: 16px; }
    .main { padding: 16px; }
    .steps-bar { overflow-x: auto; padding: 16px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div class="logo-icon">S</div>
    <h1>Signaturit <span>Bulk Sender</span></h1>
  </div>
  <div class="header-badge">v1.0 ¬∑ n8n + API</div>
</div>

<!-- STEPS -->
<div class="steps-bar">
  <div class="step-item active" data-step="1" onclick="goToStep(1)">
    <div class="step-num">1</div>
    <span class="step-label">Configuraci√≥n</span>
  </div>
  <div class="step-connector" id="conn-1-2"></div>
  <div class="step-item" data-step="2" onclick="goToStep(2)">
    <div class="step-num">2</div>
    <span class="step-label">Datos + Archivos</span>
  </div>
  <div class="step-connector" id="conn-2-3"></div>
  <div class="step-item" data-step="3" onclick="goToStep(3)">
    <div class="step-num">3</div>
    <span class="step-label">Mapeo</span>
  </div>
  <div class="step-connector" id="conn-3-4"></div>
  <div class="step-item" data-step="4" onclick="goToStep(4)">
    <div class="step-num">4</div>
    <span class="step-label">Env√≠o</span>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- STEP 1: CONFIG -->
  <div class="panel active" id="panel-1">
    <div class="section-title">‚öôÔ∏è Configuraci√≥n del env√≠o</div>
    <div class="section-desc">Configura los par√°metros globales para todas las firmas.</div>

    <div class="config-grid">
      <div class="config-card">
        <label>Entorno</label>
        <select id="cfg-env">
          <option value="sandbox">Sandbox</option>
          <option value="production">Producci√≥n</option>
        </select>
      </div>
      <div class="config-card">
        <label>Access Token</label>
        <input type="password" id="cfg-token" placeholder="Bearer token..." />
      </div>
      <div class="config-card">
        <label>Modo de env√≠o</label>
        <select id="cfg-mode">
          <option value="n8n">Via n8n Webhook</option>
          <option value="direct">Directo a API (test)</option>
        </select>
      </div>
      <div class="config-card">
        <label>Webhook URL (n8n)</label>
        <input type="text" id="cfg-webhook" placeholder="https://tu-n8n.app.n8n.cloud/webhook/..." />
      </div>
      <div class="config-card">
        <label>Delivery Type</label>
        <select id="cfg-delivery">
          <option value="email">Email</option>
          <option value="sms">SMS</option>
          <option value="url">URL (sin env√≠o)</option>
        </select>
      </div>
      <div class="config-card">
        <label>Tipo de firma</label>
        <select id="cfg-type">
          <option value="advanced">Advanced</option>
          <option value="simple">Simple</option>
          <option value="smart">Smart</option>
        </select>
      </div>
      <div class="config-card">
        <label>Branding ID (opcional)</label>
        <input type="text" id="cfg-branding" placeholder="UUID del branding..." />
      </div>
      <div class="config-card">
        <label>Signing Mode</label>
        <select id="cfg-signing-mode">
          <option value="sequential">Sequential</option>
          <option value="parallel">Parallel</option>
        </select>
      </div>
      <div class="config-card config-full">
        <label>Subject del email (opcional)</label>
        <input type="text" id="cfg-subject" placeholder="Ej: Firma de contrato - {{nombre}}" />
      </div>
      <div class="config-card config-full">
        <label>Body del email (opcional, acepta HTML)</label>
        <input type="text" id="cfg-body" placeholder="Ej: Estimado/a {{nombre}}, por favor firme el documento adjunto." />
      </div>
    </div>

    <div class="actions">
      <div></div>
      <button class="btn btn-primary" onclick="goToStep(2)">Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- STEP 2: DATA + FILES -->
  <div class="panel" id="panel-2">
    <div class="upload-section">
      <div class="section-title">üìÑ Cargar CSV con destinatarios</div>
      <div class="section-desc">CSV con columnas: nombre, email, tel√©fono, nombre_archivo, campos custom...</div>
      <div class="drop-zone" id="csv-zone" onclick="document.getElementById('csv-input').click()">
        <div class="drop-icon">üìã</div>
        <div class="drop-text">Arrastra tu CSV aqu√≠ o haz click para seleccionar</div>
        <div class="drop-hint">.csv ¬∑ separado por comas o punto y coma</div>
      </div>
      <input type="file" id="csv-input" accept=".csv" hidden />
    </div>

    <div class="upload-section">
      <div class="section-title">üìÅ Cargar PDFs</div>
      <div class="section-desc">Selecciona todos los PDFs. Se matchear√°n autom√°ticamente con la columna "archivo" del CSV.</div>
      <div class="drop-zone" id="pdf-zone" onclick="document.getElementById('pdf-input').click()">
        <div class="drop-icon">üìÇ</div>
        <div class="drop-text">Arrastra tus PDFs aqu√≠ o haz click para seleccionar</div>
        <div class="drop-hint">.pdf ¬∑ puedes seleccionar m√∫ltiples archivos</div>
      </div>
      <input type="file" id="pdf-input" accept=".pdf" multiple hidden />
    </div>

    <!-- CSV Preview -->
    <div id="csv-preview" style="display:none">
      <div class="table-container">
        <div class="table-header">
          <h3>Vista previa del CSV</h3>
          <div class="table-stats" id="csv-stats"></div>
        </div>
        <div class="table-scroll" id="csv-table-scroll"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Atr√°s</button>
      <button class="btn btn-primary" id="btn-to-mapping" onclick="goToStep(3)" disabled>Siguiente ‚Üí</button>
    </div>
  </div>

  <!-- STEP 3: MAPPING -->
  <div class="panel" id="panel-3">
    <div class="section-title">üîó Mapeo de columnas</div>
    <div class="section-desc">Asigna las columnas del CSV a los campos de la API de Signaturit.</div>

    <div class="mapping-grid">
      <div class="mapping-card">
        <span class="mapping-label">recipients[name]</span>
        <select id="map-name" class="map-select"></select>
      </div>
      <div class="mapping-card">
        <span class="mapping-label">recipients[email]</span>
        <select id="map-email" class="map-select"></select>
      </div>
      <div class="mapping-card">
        <span class="mapping-label">recipients[phone]</span>
        <select id="map-phone" class="map-select"></select>
      </div>
      <div class="mapping-card">
        <span class="mapping-label">files (nombre archivo)</span>
        <select id="map-file" class="map-select"></select>
      </div>
    </div>

    <div class="custom-fields-area">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
        <div class="section-title" style="margin-bottom:0; font-size: 14px;">üìé Campos custom (data)</div>
        <button class="btn btn-small btn-outline" onclick="addCustomField()">+ A√±adir campo</button>
      </div>
      <div class="section-desc" style="margin-bottom: 12px;">Mapea columnas del CSV a campos data[key] de la API.</div>
      <div id="custom-fields-list"></div>
    </div>

    <!-- Match Preview -->
    <div id="match-preview" style="display:none">
      <div class="table-container">
        <div class="table-header">
          <h3>Preview de env√≠o</h3>
          <div class="table-stats" id="match-stats"></div>
        </div>
        <div class="table-scroll" id="match-table-scroll"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Atr√°s</button>
      <div style="display:flex; gap:12px;">
        <button class="btn btn-secondary" onclick="generatePreview()">üîç Preview</button>
        <button class="btn btn-primary" id="btn-to-send" onclick="goToStep(4)" disabled>Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- STEP 4: SEND -->
  <div class="panel" id="panel-4">
    <div class="section-title">üöÄ Env√≠o masivo</div>
    <div class="section-desc">Revisa y lanza el env√≠o. Los archivos se env√≠an uno a uno al webhook de n8n.</div>

    <div class="webhook-info" id="send-summary"></div>

    <div class="progress-area" id="progress-area" style="display:none">
      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progress-fill"></div>
      </div>
      <div class="progress-stats">
        <span id="progress-text">0 / 0 enviados</span>
        <span id="progress-percent">0%</span>
      </div>
    </div>

    <div class="log-area" id="log-area" style="display:none"></div>

    <div id="send-results" style="display:none">
      <div class="table-container">
        <div class="table-header">
          <h3>Resultados</h3>
          <div class="table-stats" id="results-stats"></div>
        </div>
        <div class="table-scroll" id="results-table-scroll"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary" onclick="goToStep(3)" id="btn-back-send">‚Üê Atr√°s</button>
      <div style="display:flex; gap:12px;">
        <button class="btn btn-secondary" id="btn-export-log" onclick="exportLog()" style="display:none">üì• Exportar log</button>
        <button class="btn btn-success" id="btn-send" onclick="startSending()">üöÄ Iniciar env√≠o</button>
      </div>
    </div>
  </div>

</div>

<script>
// === STATE ===
let currentStep = 1;
let csvData = [];
let csvHeaders = [];
let pdfFiles = {};
let matchedData = [];
let sendLog = [];
let sending = false;

// === STEP NAVIGATION ===
function goToStep(step) {
  if (sending) return;
  currentStep = step;
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${step}`).classList.add('active');

  document.querySelectorAll('.step-item').forEach(s => {
    const sStep = parseInt(s.dataset.step);
    s.classList.remove('active', 'completed');
    if (sStep === step) s.classList.add('active');
    else if (sStep < step) s.classList.add('completed');
  });

  for (let i = 1; i <= 3; i++) {
    const conn = document.getElementById(`conn-${i}-${i+1}`);
    if (conn) conn.classList.toggle('active', i < step);
  }

  if (step === 3) populateMappingSelects();
  if (step === 4) prepareSendSummary();
}

// === CSV HANDLING ===
function parseCSV(text) {
  const sep = text.indexOf(';') !== -1 && text.indexOf(',') === -1 ? ';' : 
              text.split('\n')[0].split(';').length > text.split('\n')[0].split(',').length ? ';' : ',';
  const lines = text.trim().split('\n');
  const headers = lines[0].split(sep).map(h => h.trim().replace(/^["']|["']$/g, ''));
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const vals = lines[i].split(sep).map(v => v.trim().replace(/^["']|["']$/g, ''));
    const row = {};
    headers.forEach((h, idx) => row[h] = vals[idx] || '');
    rows.push(row);
  }
  return { headers, rows };
}

function handleCSV(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    const result = parseCSV(e.target.result);
    csvHeaders = result.headers;
    csvData = result.rows;
    showCSVPreview();
    updateUploadZone('csv-zone', `‚úÖ ${file.name} ‚Äî ${csvData.length} filas, ${csvHeaders.length} columnas`);
    checkStep2Ready();
  };
  reader.readAsText(file);
}

function showCSVPreview() {
  const preview = document.getElementById('csv-preview');
  preview.style.display = 'block';
  
  const stats = document.getElementById('csv-stats');
  stats.innerHTML = `
    <span class="stat-badge">${csvData.length} filas</span>
    <span class="stat-badge">${csvHeaders.length} columnas</span>
  `;

  const scroll = document.getElementById('csv-table-scroll');
  const maxRows = Math.min(csvData.length, 10);
  let html = '<table><thead><tr><th>#</th>';
  csvHeaders.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  for (let i = 0; i < maxRows; i++) {
    html += `<tr><td>${i + 1}</td>`;
    csvHeaders.forEach(h => html += `<td title="${csvData[i][h]}">${csvData[i][h]}</td>`);
    html += '</tr>';
  }
  if (csvData.length > 10) {
    html += `<tr><td colspan="${csvHeaders.length + 1}" style="text-align:center; color: var(--text-dim);">... y ${csvData.length - 10} filas m√°s</td></tr>`;
  }
  html += '</tbody></table>';
  scroll.innerHTML = html;
}

// === PDF HANDLING ===
function handlePDFs(files) {
  pdfFiles = {};
  Array.from(files).forEach(f => {
    pdfFiles[f.name.toLowerCase()] = f;
  });
  updateUploadZone('pdf-zone', `‚úÖ ${Object.keys(pdfFiles).length} archivos PDF cargados`);
  checkStep2Ready();
}

function updateUploadZone(id, msg) {
  const zone = document.getElementById(id);
  zone.classList.add('has-file');
  zone.innerHTML = `<div class="file-info">${msg}</div>`;
}

function checkStep2Ready() {
  document.getElementById('btn-to-mapping').disabled = !(csvData.length > 0 && Object.keys(pdfFiles).length > 0);
}

// === MAPPING ===
function populateMappingSelects() {
  const selects = document.querySelectorAll('.map-select');
  const autoMap = {
    'map-name': ['nombre', 'name', 'destinatario', 'recipient', 'signer'],
    'map-email': ['email', 'correo', 'mail', 'e-mail'],
    'map-phone': ['telefono', 'phone', 'tel', 'm√≥vil', 'movil', 'celular'],
    'map-file': ['archivo', 'file', 'documento', 'document', 'pdf', 'fichero', 'nombre_archivo']
  };

  selects.forEach(sel => {
    sel.innerHTML = '<option value="">‚Äî Sin asignar ‚Äî</option>';
    csvHeaders.forEach(h => {
      sel.innerHTML += `<option value="${h}">${h}</option>`;
    });

    // Auto-map
    const key = sel.id;
    if (autoMap[key]) {
      const match = csvHeaders.find(h => autoMap[key].some(k => h.toLowerCase().includes(k)));
      if (match) sel.value = match;
    }
  });
}

function addCustomField() {
  const list = document.getElementById('custom-fields-list');
  const div = document.createElement('div');
  div.className = 'custom-field-row';
  div.innerHTML = `
    <input type="text" placeholder="Nombre del campo (key)" class="custom-key" />
    <select class="custom-col">
      <option value="">‚Äî Columna CSV ‚Äî</option>
      ${csvHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}
    </select>
    <button class="btn-remove-field" onclick="this.parentElement.remove()">√ó</button>
  `;
  list.appendChild(div);
}

// === PREVIEW ===
function generatePreview() {
  const mapName = document.getElementById('map-name').value;
  const mapEmail = document.getElementById('map-email').value;
  const mapPhone = document.getElementById('map-phone').value;
  const mapFile = document.getElementById('map-file').value;

  if (!mapName || !mapEmail || !mapFile) {
    alert('Debes asignar al menos: nombre, email y archivo.');
    return;
  }

  matchedData = csvData.map((row, idx) => {
    const fileName = row[mapFile]?.toLowerCase() || '';
    const fileNamePdf = fileName.endsWith('.pdf') ? fileName : fileName + '.pdf';
    const matched = pdfFiles[fileNamePdf] || pdfFiles[fileName] || null;

    return {
      index: idx + 1,
      name: row[mapName] || '',
      email: row[mapEmail] || '',
      phone: row[mapPhone] || '',
      fileName: row[mapFile] || '',
      fileMatched: !!matched,
      file: matched,
      rawRow: row
    };
  });

  const matchCount = matchedData.filter(m => m.fileMatched).length;
  const missCount = matchedData.length - matchCount;

  const preview = document.getElementById('match-preview');
  preview.style.display = 'block';

  document.getElementById('match-stats').innerHTML = `
    <span class="stat-badge success">‚úÖ ${matchCount} matched</span>
    ${missCount > 0 ? `<span class="stat-badge error">‚ùå ${missCount} sin archivo</span>` : ''}
  `;

  const scroll = document.getElementById('match-table-scroll');
  let html = '<table><thead><tr><th>#</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Archivo</th><th>Estado</th></tr></thead><tbody>';
  matchedData.forEach(m => {
    html += `<tr>
      <td>${m.index}</td>
      <td>${m.name}</td>
      <td>${m.email}</td>
      <td>${m.phone || '‚Äî'}</td>
      <td>${m.fileName}</td>
      <td><span class="status-dot ${m.fileMatched ? 'matched' : 'missing'}"></span>${m.fileMatched ? 'OK' : 'Sin archivo'}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  scroll.innerHTML = html;

  document.getElementById('btn-to-send').disabled = matchCount === 0;
}

// === SEND SUMMARY ===
function prepareSendSummary() {
  const env = document.getElementById('cfg-env').value;
  const mode = document.getElementById('cfg-mode').value;
  const webhook = document.getElementById('cfg-webhook').value;
  const delivery = document.getElementById('cfg-delivery').value;
  const total = matchedData.filter(m => m.fileMatched).length;

  const apiUrl = env === 'sandbox' ? 'https://api.sandbox.signaturit.com/v3/signatures.json' : 'https://api.signaturit.com/v3/signatures.json';

  document.getElementById('send-summary').innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
      <div><span style="color:var(--text-muted)">Entorno:</span> <code>${env}</code></div>
      <div><span style="color:var(--text-muted)">Modo:</span> <code>${mode}</code></div>
      <div><span style="color:var(--text-muted)">API URL:</span> <code>${apiUrl}</code></div>
      <div><span style="color:var(--text-muted)">Delivery:</span> <code>${delivery}</code></div>
      <div><span style="color:var(--text-muted)">Total a enviar:</span> <code>${total}</code></div>
      ${mode === 'n8n' ? `<div><span style="color:var(--text-muted)">Webhook:</span> <code>${webhook || '‚ö†Ô∏è No configurado'}</code></div>` : ''}
    </div>
  `;
}

// === SENDING ===
async function startSending() {
  const mode = document.getElementById('cfg-mode').value;
  const token = document.getElementById('cfg-token').value;
  const env = document.getElementById('cfg-env').value;
  const webhook = document.getElementById('cfg-webhook').value;
  const delivery = document.getElementById('cfg-delivery').value;
  const sigType = document.getElementById('cfg-type').value;
  const branding = document.getElementById('cfg-branding').value;
  const signingMode = document.getElementById('cfg-signing-mode').value;
  const subject = document.getElementById('cfg-subject').value;
  const body = document.getElementById('cfg-body').value;

  if (!token) { alert('Falta el Access Token'); return; }
  if (mode === 'n8n' && !webhook) { alert('Falta la URL del webhook de n8n'); return; }

  const apiUrl = env === 'sandbox' 
    ? 'https://api.sandbox.signaturit.com/v3/signatures.json'
    : 'https://api.signaturit.com/v3/signatures.json';

  const toSend = matchedData.filter(m => m.fileMatched);
  if (toSend.length === 0) { alert('No hay registros con archivo para enviar'); return; }

  sending = true;
  sendLog = [];
  document.getElementById('btn-send').disabled = true;
  document.getElementById('btn-back-send').disabled = true;
  document.getElementById('progress-area').style.display = 'block';
  document.getElementById('log-area').style.display = 'block';
  document.getElementById('send-results').style.display = 'none';

  // Get custom fields
  const customFields = [];
  document.querySelectorAll('.custom-field-row').forEach(row => {
    const key = row.querySelector('.custom-key').value;
    const col = row.querySelector('.custom-col').value;
    if (key && col) customFields.push({ key, col });
  });

  let sent = 0, failed = 0;

  for (let i = 0; i < toSend.length; i++) {
    const item = toSend[i];
    const progress = ((i + 1) / toSend.length * 100).toFixed(1);
    document.getElementById('progress-fill').style.width = progress + '%';
    document.getElementById('progress-text').textContent = `${i + 1} / ${toSend.length} procesados`;
    document.getElementById('progress-percent').textContent = progress + '%';

    addLog(`[${i+1}/${toSend.length}] Enviando a ${item.email}...`, 'info');

    try {
      const formData = new FormData();
      formData.append('recipients[0][name]', item.name);
      formData.append('recipients[0][email]', item.email);
      if (item.phone) formData.append('recipients[0][phone]', item.phone);
      formData.append('files[0]', item.file, item.file.name);

      if (delivery !== 'email') formData.append('delivery_type', delivery);
      if (sigType !== 'advanced') formData.append('type', sigType);
      if (branding) formData.append('branding_id', branding);
      if (signingMode !== 'sequential') formData.append('signing_mode', signingMode);
      
      // Replace placeholders in subject/body
      let finalSubject = subject.replace(/\{\{nombre\}\}/gi, item.name).replace(/\{\{email\}\}/gi, item.email);
      let finalBody = body.replace(/\{\{nombre\}\}/gi, item.name).replace(/\{\{email\}\}/gi, item.email);
      if (finalSubject) formData.append('subject', finalSubject);
      if (finalBody) formData.append('body', finalBody);

      // Custom data fields
      customFields.forEach(cf => {
        const val = item.rawRow[cf.col] || '';
        formData.append(`data[${cf.key}]`, val);
      });

      let response;
      if (mode === 'direct') {
        // Direct API call (only works if CORS allows it ‚Äî mainly for testing)
        response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
      } else {
        // Via n8n webhook
        formData.append('_token', token);
        formData.append('_api_url', apiUrl);
        response = await fetch(webhook, {
          method: 'POST',
          body: formData
        });
      }

      if (response.ok) {
        const data = await response.json().catch(() => ({}));
        item.status = 'sent';
        item.responseId = data.id || '‚Äî';
        sent++;
        addLog(`‚úÖ ${item.email} ‚Üí OK (ID: ${item.responseId})`, 'success');
      } else {
        const errText = await response.text().catch(() => 'Unknown error');
        item.status = 'failed';
        item.error = `HTTP ${response.status}: ${errText.substring(0, 100)}`;
        failed++;
        addLog(`‚ùå ${item.email} ‚Üí ${item.error}`, 'error');
      }
    } catch (err) {
      item.status = 'failed';
      item.error = err.message;
      failed++;
      addLog(`‚ùå ${item.email} ‚Üí ${err.message}`, 'error');
    }

    // Small delay to not overwhelm the API
    if (i < toSend.length - 1) await sleep(500);
  }

  // Results
  addLog(`\n=== COMPLETADO: ${sent} enviados, ${failed} fallidos ===`, sent === toSend.length ? 'success' : 'error');
  showResults(toSend, sent, failed);

  sending = false;
  document.getElementById('btn-send').disabled = false;
  document.getElementById('btn-send').textContent = 'üîÑ Re-enviar fallidos';
  document.getElementById('btn-send').onclick = () => retrySending();
  document.getElementById('btn-back-send').disabled = false;
  document.getElementById('btn-export-log').style.display = 'flex';
}

function showResults(data, sent, failed) {
  const container = document.getElementById('send-results');
  container.style.display = 'block';

  document.getElementById('results-stats').innerHTML = `
    <span class="stat-badge success">‚úÖ ${sent} enviados</span>
    ${failed > 0 ? `<span class="stat-badge error">‚ùå ${failed} fallidos</span>` : ''}
  `;

  const scroll = document.getElementById('results-table-scroll');
  let html = '<table><thead><tr><th>#</th><th>Email</th><th>Archivo</th><th>Estado</th><th>ID / Error</th></tr></thead><tbody>';
  data.forEach(m => {
    const st = m.status === 'sent' ? 'sent' : 'failed';
    html += `<tr>
      <td>${m.index}</td>
      <td>${m.email}</td>
      <td>${m.fileName}</td>
      <td><span class="status-dot ${st}"></span>${m.status === 'sent' ? 'Enviado' : 'Fallido'}</td>
      <td>${m.status === 'sent' ? m.responseId : m.error}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  scroll.innerHTML = html;
}

async function retrySending() {
  const failedItems = matchedData.filter(m => m.status === 'failed');
  if (failedItems.length === 0) { alert('No hay env√≠os fallidos para reintentar'); return; }
  // Reset failed status
  failedItems.forEach(m => { m.status = undefined; m.error = undefined; });
  document.getElementById('btn-send').textContent = 'üöÄ Iniciar env√≠o';
  document.getElementById('btn-send').onclick = () => startSending();
  startSending();
}

function addLog(msg, type = '') {
  const area = document.getElementById('log-area');
  const line = document.createElement('div');
  line.className = `log-line ${type}`;
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  area.appendChild(line);
  area.scrollTop = area.scrollHeight;
  sendLog.push(line.textContent);
}

function exportLog() {
  const blob = new Blob([sendLog.join('\n')], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `signaturit_bulk_log_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// === DRAG & DROP ===
['csv-zone', 'pdf-zone'].forEach(id => {
  const zone = document.getElementById(id);
  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (id === 'csv-zone' && e.dataTransfer.files[0]) {
      handleCSV(e.dataTransfer.files[0]);
    } else if (id === 'pdf-zone') {
      handlePDFs(e.dataTransfer.files);
    }
  });
});

document.getElementById('csv-input').addEventListener('change', (e) => {
  if (e.target.files[0]) handleCSV(e.target.files[0]);
});

document.getElementById('pdf-input').addEventListener('change', (e) => {
  if (e.target.files.length > 0) handlePDFs(e.target.files);
});
</script>
</body>
</html>
